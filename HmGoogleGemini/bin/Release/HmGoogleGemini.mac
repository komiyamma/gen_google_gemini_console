jsmode @"WebView2\HmGoogleGemini";
js {

/// <reference path="../types/hm_jsmode.d.ts" />

let projectId = "new-project-20240307";
let location = "us-central1";
let model = "gemini-1.0-pro";
debuginfo(2);
function openRenderPaneCommand(port) {
console.log(port);
    const json_param = {
        // target: "HmGoogleGemini",
        target: "_each",
            uri: "http://localhost:"+port+"/HmGoogleGemini.html",
            show: 1,
            place: "rightside",
            size: 300,
            initialize: "async",
        };
    browserpanecommand(json_param)
}


let currentmacrodir = currentmacrodirectory();
let hidemaruexedir = hidemarudir();

let currentexepath = currentmacrodir + "\\HmGoogleGemini.exe";


function outputAlert(msg) {
    let dll = loaddll(hidemaruexedir + "\\HmOutputPane.dll");
    dll.dllFuncW.Output(msg + "\r\n");
}

let saveFileName = currentmacrodir + "\\HmGoogleGemini.question.txt";

let ticknum = tickcount() & 0x7fffffff;

function doSendQuestionContent() {
    try {
        let text = hidemaru.getSelectedText();
        let commandline = `"${currentexepath}" "${projectId}" "${location}" "${model}"`;
        // runex(commandline, 0, 0, "", 0, "", 0, "", 0, "", 2, 1, 0, 0);
        runex(commandline, 0);

        let sendcmd = "HmGoogleGemini.Message(" + ticknum + ")\n";
        hidemaru.setTimeout(
            () => { hidemaru.saveTextFile(saveFileName, sendcmd + text, "utf8"); },
            200
        );
    } catch (err) {
        outputAlert(err);
    }
}

function doSendCommand() {
    let selectMenuID = menu("AI応答のキャンセル", "リセット");
    if (selectMenuID == 1) {
        let sendcmd = "HmGoogleGemini.Cancel(" + ticknum + ")\n";
        let text = "キャンセル";
        let commandline = `"${currentexepath}"`;
        runex(commandline, 0);
        hidemaru.saveTextFile(saveFileName, sendcmd + text, "utf8");
    }
    else if (selectMenuID == 2) {
        let sendcmd = "HmGoogleGemini.Clear(" + ticknum + ")\n";
        let text = "リセット";
        let commandline = `"${currentexepath}" "HmGoogleGemini.Clear()"`;
        runex(commandline, 0);
        hidemaru.saveTextFile(saveFileName, sendcmd + text, "utf8");
    }
}

var port = 55555;
function openHttpServer(port) {
    let currentphppath = currentmacrodir + "\\php.exe";
    let commandline = `"${currentphppath}" -S localhost:${port} -t "${currentmacrodir}"`;
    runex(commandline, 0, 0, "", 0, "", 0, "", 0, "", 0, 0, 0, 0);
}

function doMain() {
    openHttpServer(port)
    openRenderPaneCommand(port);
    if (selecting()) {
        doSendQuestionContent();
    } else {
        doSendCommand();
    }
}

doMain();

} // js

